/*! museum-guide | Patrick Dorosz | ISC */

var museumMapApp=function(){"use strict";var e=[{featureType:"all",elementType:"labels.text.fill",stylers:[{color:"#736c68"}]},{featureType:"landscape.man_made",elementType:"geometry.fill",stylers:[{color:"#e7e6e5"}]},{featureType:"landscape.natural",elementType:"all",stylers:[{visibility:"on"},{color:"#d4e4d3"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#f5f5f5"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#d4e4d3"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#f5f5f5"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#e7e6e5"},{gamma:"0.65"},{lightness:"0"}]},{featureType:"transit",elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#aad5df"}]}],t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),o=function(){function e(r,o){t(this,e),this.placesService=new window.google.maps.places.PlacesService(r),this.googleMapView=o}return r(e,[{key:"livePlacesSearch",value:function(e,t,r,o,n){function a(e,t){if(t===window.google.maps.places.PlacesServiceStatus.OK){var r=e.slice(0,10).map(function(e){return e.place_id});i.getDetailsFromPlaceIds(r,n)}else if(t===window.google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT)window.setTimeout(function(){i.placesService.nearbySearch(s,a)},200);else{var o=new Error(t);i.googleMapView.loadPlacesSearchResults(o)}}var i=this,s={keyword:e,location:t,name:o,radius:1e4,type:r};i.placesService.nearbySearch(s,a)}},{key:"getDetailsFromPlaceIds",value:function(e,t){var r=this,o=e.map(function(e){return new Promise(function(t,o){r.getDetailsFromSinglePlaceId(e,t,o)})});Promise.all(o).then(r.formatResults).then(function(e){r.googleMapView.loadPlacesSearchResults(e,t)}).catch(function(e){r.googleMapView.loadPlacesSearchResults(e,t)})}},{key:"getDetailsFromSinglePlaceId",value:function(e,t,r){var o=this;o.placesService.getDetails({placeId:e},function(n,a){if(a===window.google.maps.places.PlacesServiceStatus.OK)t(n);else if(a===window.google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT)window.setTimeout(function(){o.getDetailsFromSinglePlaceId(e,t,r)},200);else{var i=new Error(a);r(i)}})}},{key:"formatResults",value:function(e){return e.map(function(e){return{title:e.name,position:{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},type:"general",place_id:e.place_id}})}}]),e}(),n=function(){return{getYelpInfoHtml:function(e,t){var r='<div class="yelp">';return r+='<img class="yelp__image" src='+e.image_url.replace(/o\.jpg$/,"l.jpg")+' alt="Museum">',r+='<div class="yelp__info">',r+='<a class="yelp__rating" href="'+e.url+'" target="_blank">',r+=function(e){var t=Math.floor(e),r=e-t==.5?"_half":"",o='<img src="img/yelp_stars_reg/regular_';return o+=""+t+r+'.png" srcset="img/yelp_stars_reg/',o+="regular_"+t+r+'@2x.png 2x">'}(e.rating)+"</a>",r+='<a target="_blank" href="'+e.url+'">',r+='<img class="yelp__logo" src="img/yelp_trademark_rgb_outline.png" ',r+='srcset="img/yelp_trademark_rgb_outline_2x.png 2x" alt="Yelp Logo">',r+="</a>",r+='<a class="yelp__reviews" href="'+e.url+'" target="_blank">Based ',r+="on <strong>"+e.review_count+"</strong> review",r+=(e.review_count>1?"s":"")+"</a>",r+='<address class="yelp__address">'+function(e,t){return e[e.length-1].toLowerCase()===t.toLowerCase()&&(e=e.slice(0,e.length-1)),e.join("<br>")}(e.location.display_address,t),r+="</address>",e.hasOwnProperty("is_open_now")?(r+='<p class="yelp__open-now-phone">Currently <strong>',r+=(e.is_open_now?"OPEN":"CLOSED")+"</strong><br>"):r+='<p class="yelp__open-now-phone">',r+="Phone: "+e.display_phone+"</p>",r+="</div>",r+="</div>"},fetchYelpInfo:function(e,t){var r=t+"/yelp-search?term="+e.title.replace(/\s+/g,"+")+"&";return r+="lat="+e.position.lat()+"&",r+="lng="+e.position.lng(),window.fetch(r,{method:"GET"}).catch(function(e){return Promise.reject(e)}).then(function(e){return e.ok?e:Promise.reject(new Error("api.yelp.com connection error"))}).then(function(e){return e.json()})}}}(),a=function(){var e='<div class="sk-circle">';return Array(12).fill().map(function(e,t){return t+1}).forEach(function(t){e+='<div class="sk-circle'+t+' sk-child"></div>'}),e+="</div>"}(),i=function(e){var t="abcdefghijklmnopqrstuvwxyz0123456789",r="";e=e||6;for(var o=0;o<e;o++)r+=t.charAt(Math.floor(Math.random()*t.length));return r},s=function(){function s(){t(this,s)}return r(s,null,[{key:"closeInfoWindow",value:function(){s.mainInfoWindow.close(),s.mainInfoWindow.marker=void 0,c.instance.setSelectedMarker(void 0)}},{key:"deleteMarkers",value:function(){s.markers.forEach(function(e){e.setMap(void 0)}),s.markers=[],c.instance.clearMarkersObservable(),s.currentBounds=new window.google.maps.LatLngBounds}},{key:"errorLoadMap",value:function(){c.openErrorLoadingScreen(),c.instance&&c.instance.notifyMapLoadFail(!0)}},{key:"hideListView",value:function(){var e=document.getElementsByClassName("sidebar");if(e[0].classList.contains("sidebar--show")){var t=!0,r=!1,o=void 0;try{for(var n,a=e[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var i=n.value;i.classList.add("sidebar--hide"),i.classList.remove("sidebar--show")}}catch(e){r=!0,o=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw o}}}}},{key:"initMap",value:function(){s.initialLoadPromise.then(function(){var t=document.getElementsByClassName("map")[0];s.map=new window.google.maps.Map(t,{center:{lat:s.defaultPosition.lat,lng:s.defaultPosition.lng},zoom:12,styles:e}),s.placesSearch=new o(s.map,s);document.getElementsByClassName("sidebar-list__live-search-loading")[0].insertAdjacentHTML("afterbegin",a),window.onresize=s.onWindowResize,t.addEventListener("click",s.hideListView),s.markers=[],(s.mainInfoWindow=new window.google.maps.InfoWindow({maxWidth:250})).addListener("closeclick",function(){s.mainInfoWindow.marker=void 0,c.instance.setSelectedMarker(void 0)}),c.closeFormLoadingMode()}).catch(function(e){return e})}},{key:"livePlacesSearch",value:function(e,t,r){var o=i(5);s.currentSearchSessionHash=o,s.deleteMarkers(),s.placesSearch.livePlacesSearch(e,t,s.defaultType,r,o)}},{key:"loadMode",value:function(e,t){void 0!==s.mode&&s.modelCityObj===e&&"curated"===t&&"curated"===s.mode||(s.deleteMarkers(),s.modelCityObj=e,s.mode=t,"curated"===t&&s.loadMarkers(e.locations)),s.resetMap()}},{key:"loadMarkers",value:function(e){e.forEach(function(e){var t=new window.google.maps.Marker({position:e.position,title:e.title,animation:window.google.maps.Animation.DROP,icon:"img/icons/"+e.type+".png",map:s.map});t.addListener("click",function(){s.hideListView(),s.popInfoWindow(this)}),s.markers.push(t),s.currentBounds.extend(t.position)}),c.instance.markersReady(""),c.instance.markersReady(s.modelCityObj.cityName)}},{key:"loadPlacesSearchResults",value:function(e,t){t===s.currentSearchSessionHash&&(e instanceof Error?c.instance.searchPlacesCompleted("error"):0===e.length?c.instance.searchPlacesCompleted("noresults"):(s.deleteMarkers(),s.loadMarkers(e),s.map.fitBounds(s.currentBounds),c.instance.searchPlacesCompleted("success")))}},{key:"onWindowResize",value:function(){if(c.instance){var e=c.instance.getVisibleMarkers();e.length>1?s.mainInfoWindow.marker?(s.map.panTo(s.mainInfoWindow.marker.position),s.map.panBy(0,-340)):(s.resizeBounds=new window.google.maps.LatLngBounds,e.forEach(function(e){s.resizeBounds.extend(e.position)}),s.map.fitBounds(s.resizeBounds),s.resizeBounds=void 0,s.map.getZoom()>18&&s.map.setZoom(18)):1===e.length&&(s.map.panTo(e[0].position),s.map.panBy(0,-340))}if(window.matchMedia("(min-width: 768px)").matches){var t=document.getElementsByClassName("sidebar"),r=!0,o=!1,n=void 0;try{for(var a,i=t[Symbol.iterator]();!(r=(a=i.next()).done);r=!0){a.value.classList.remove("sidebar--show")}}catch(e){o=!0,n=e}finally{try{!r&&i.return&&i.return()}finally{if(o)throw n}}}}},{key:"popInfoWindow",value:function(e){function t(){var e=document.getElementsByClassName("info-window__arrows")[0],t="css: { 'btn--disabled': markersObservable().length < 2 }";e&&(e.children[0].setAttribute("data-bind","click: clickPrevArrow, "+t),e.children[1].setAttribute("data-bind","click: clickNextArrow, "+t),window.ko.applyBindings(c.instance,e))}function r(e,t){var r='<div class="info-window">';return r+='<div class="info-window__title"><strong>'+t+"</strong></div>",r+=e,r+=function(){var e='<div class="info-window__arrows">';return e+='<a href="#" role="button" class="btn info-window__arrows-prev"',e+='><span class="bof">&lt;</span></a>',e+='<a href="#" class="btn info-window__arrows-next" role="button"',e+='><span class="bof">&gt;</span></a>',e+="</div>"}(),r+="</div>"}if(s.toggleBounceMarker(e),s.mainInfoWindow.marker!==e){s.mainInfoWindow.marker=e,c.instance.setSelectedMarker(e),s.map.panTo(e.position),s.map.panBy(0,-340);var o=r(a,e.title);s.mainInfoWindow.setContent(o),s.mainInfoWindow.open(s.map,e),t(),n.fetchYelpInfo(e,s.corsServer).then(function(a){if(s.mainInfoWindow.marker===e){if(0===Object.keys(a).length){var i="<p>This location's information is not found in Yelp's business ";o=r(i+="directory. Try a different location.</p>",e.title),s.mainInfoWindow.setContent(o),t()}else{var l=n.getYelpInfoHtml(a,s.modelCityObj.country);o=r(l,e.title),s.mainInfoWindow.setContent(o),t()}}}).catch(function(n){if(s.mainInfoWindow.marker===e){var a="<p>Unable to retrieve this location's Yelp data due to a ";return a+="connection error. Please try again later.</p>",o=r(a,"Loading Error"),s.mainInfoWindow.setContent(o),t(),n}})}}},{key:"queryBoundsExtend",value:function(e){s.queryBounds||(s.queryBounds=new window.google.maps.LatLngBounds),s.queryBounds.extend(e)}},{key:"queryBoundsFit",value:function(e){e&&s.map.fitBounds(s.queryBounds),s.queryBounds=void 0,s.map.getZoom()>18&&s.map.setZoom(18)}},{key:"resetMap",value:function(){"curated"===s.mode?s.map.fitBounds(s.currentBounds):"liveSearch"===s.mode&&(s.currentSearchSessionHash=void 0,s.deleteMarkers(),s.map.panTo(s.modelCityObj.position)),s.mainInfoWindow.marker=void 0,s.mainInfoWindow.close(),c.instance.setSelectedMarker(void 0)}},{key:"returnModule",value:function(){return{errorLoadMap:s.errorLoadMap,initMap:s.initMap}}},{key:"setMarkerOnMap",value:function(e,t){t?e.setMap(s.map):e.setMap(void 0)}},{key:"toggleBounceMarker",value:function(e){e.getAnimation()?e.setAnimation(void 0):(s.markers.forEach(function(e){e.setAnimation(void 0)}),e.setAnimation(window.google.maps.Animation.BOUNCE),setTimeout(function(){return e.setAnimation(void 0)},1500))}}]),s}(),l=new(function(){function e(){t(this,e),this.modalElement=document.getElementsByClassName("modal")[0],this.modalElementContent=document.getElementsByClassName("modal__content")[0],this.modalElementCloseBtn=document.getElementsByClassName("modal__close-btn")[0],this.formLoadingScreen=document.getElementsByClassName("form__load-screen")[0],this.formErrorLoadingScreen=document.getElementsByClassName("form__load-error-screen")[0],this.isInitialModal=!0,this.formLoadingScreen.insertAdjacentHTML("beforeend",a),setTimeout(this.launchFirstModal.bind(this),350),this.events()}return r(e,[{key:"events",value:function(){document.addEventListener("keyup",this.keyPressHandler.bind(this))}},{key:"launchFirstModal",value:function(){this.modalElementContent.classList.remove("modal__content--hidden")}},{key:"openModal",value:function(){!0===this.isInitialModal&&(this.isInitialModal=!1,this.modalElementCloseBtn.classList.remove("modal__close-btn--hidden")),this.modalElement.classList.remove("modal--hidden")}},{key:"closeFormLoadingMode",value:function(){this.formLoadingScreen.classList.remove("form__load-screen--visible")}},{key:"closeModal",value:function(e){e.modalElement.classList.add("modal--hidden"),e.formLoadingScreen.classList.remove("form__load-screen--visible")}},{key:"keyPressHandler",value:function(e){27===e.keyCode&&!1===this.isInitialModal&&this.closeModal(this)}},{key:"openErrorLoadingScreen",value:function(){this.formErrorLoadingScreen.classList.add("form__load-error-screen--visible")}},{key:"openFormLoadingMode",value:function(){this.formLoadingScreen.classList.add("form__load-screen--visible")}}]),e}()),c=function(){function e(r){t(this,e);var o=this;o.mapLoadFail=window.ko.observable(!1),o.markersReady=window.ko.observable("").extend({notify:"always"}),o.markersObservable=window.ko.observableArray([]),o.selectedMarker=window.ko.observable(void 0),o.createMarkersObservable=window.ko.computed(function(){if(o.markersReady())return o.markersObservable(s.markers),o.markersSort(o.markersObservable),!0},o),o.query=window.ko.observable(""),o.queryOld=window.ko.observable(""),o.queryPlaceholder=window.ko.observable(""),o.query.subscribe(o.queryProcessInput,o),o.queryLiveSearch=window.ko.observable(o.query()),o.queryLiveSearchDelayed=window.ko.pureComputed(o.queryLiveSearch).extend({rateLimit:{method:"notifyWhenChangesStop",timeout:750}}),o.queryLiveSearchDelayed.subscribe(o.searchPlaces,o),o.queryLiveSearchLoading=window.ko.observable(!1),o.queryLiveSearchResultText=window.ko.observable(""),o.computedCityString=window.ko.observable(),o.displayedCityString=window.ko.observable(),o.form={},o.form.selectedCityValue=window.ko.observable("Tokyo"),o.form.selectedListMode=window.ko.observable("curated"),o.form.optionsCities=r.cities.map(function(e){return{cityString:e.cityName+(e.localLang?" - "+e.localLang:""),cityValue:e.cityName}}),o.form.selectedCityObj=window.ko.computed(function(){var e=r.cities.find(function(e){return e.cityName.toLowerCase()===o.form.selectedCityValue().toLowerCase()});return e&&(e.localLang?o.computedCityString(e.cityName+" - "+e.localLang):o.computedCityString(e.cityName)),e}),o.form.curatedDisabled=window.ko.computed(function(){return 0===o.form.selectedCityObj().locations.length?(o.form.selectedListMode("liveSearch"),!0):(o.form.selectedListMode("curated"),!1)})}return r(e,[{key:"clickArrow",value:function(e){if(this.markersObservable().length>1){var t=(this.markersObservable.indexOf(s.mainInfoWindow.marker)+e)%this.markersObservable().length;-1===t&&(t=this.markersObservable().length-1);var r=this.markersObservable()[t];s.popInfoWindow(r)}}},{key:"clickLocationList",value:function(t){window.matchMedia("(max-width: 767px)").matches&&e.instance.toggleSidebar(),s.popInfoWindow(t)}},{key:"changeCity",value:function(){l.openModal()}},{key:"clickNextArrow",value:function(){this.clickArrow(1)}},{key:"clickPrevArrow",value:function(){this.clickArrow(-1)}},{key:"closeModal",value:function(){l.closeModal(l)}},{key:"clearMarkersObservable",value:function(){this.markersObservable([])}},{key:"filterMarkerList",value:function(e){if(""!==e){this.markersObservable([]),s.markers.forEach(function(t){t.title.toUpperCase().indexOf(e.toUpperCase())>=0?(this.markersObservable.push(t),t.getMap()||s.setMarkerOnMap(t,!0),s.queryBoundsExtend(t.position)):s.setMarkerOnMap(t,!1)},this);var t=this.markersObservable().length;1===t?(s.mainInfoWindow.marker||s.popInfoWindow(this.markersObservable()[0]),s.queryBoundsFit(!1)):t>1&&(s.closeInfoWindow(),this.markersSort(this.markersObservable),s.queryBoundsFit(!0))}else s.markers.forEach(function(e){e.getMap()||s.setMarkerOnMap(e,!0)}),this.markersObservable(s.markers),this.markersSort(this.markersObservable),this.resetMap()}},{key:"getVisibleMarkers",value:function(){return this.markersObservable()}},{key:"listElementInfoWindowOpen",value:function(e){return this.selectedMarker()===e}},{key:"loadFormData",value:function(){"curated"===this.form.selectedListMode()?(this.queryPlaceholder("Filter..."),s.loadMode(this.form.selectedCityObj(),"curated")):"liveSearch"===this.form.selectedListMode()&&(this.queryPlaceholder("Search..."),s.loadMode(this.form.selectedCityObj(),"liveSearch")),this.query(""),this.queryLiveSearchResultText(""),this.displayedCityString(this.computedCityString()),l.closeModal(l)}},{key:"notifyMapLoadFail",value:function(e){this.mapLoadFail(e)}},{key:"markersSort",value:function(e){e.sort(function(e,t){return e.title===t.title?0:e.title>t.title?1:-1})}},{key:"queryProcessInput",value:function(e){(e=e.trim())!==this.queryOld()&&(this.queryOld(e),"curated"===this.form.selectedListMode()?this.filterMarkerList(e):"liveSearch"===this.form.selectedListMode()&&this.queryLiveSearch(this.query()))}},{key:"resetMap",value:function(){this.query(""),this.queryLiveSearchResultText(""),this.queryLiveSearchLoading(!1),s.resetMap()}},{key:"searchPlaces",value:function(e){if(e.length>2){this.queryLiveSearchLoading(!0);var t=this.form.selectedCityObj().cityName,r=this.form.selectedCityObj().position;s.livePlacesSearch(t,r,e)}}},{key:"searchPlacesCompleted",value:function(e){this.queryLiveSearchLoading(!1),"success"===e?this.queryLiveSearchResultText(""):"noresults"===e?this.queryLiveSearchResultText("No Results"):"error"===e&&this.queryLiveSearchResultText("Search Error")}},{key:"setSelectedMarker",value:function(e){this.selectedMarker(e)}},{key:"submitModal",value:function(){l.openFormLoadingMode(),this.loadFormData()}},{key:"toggleSidebar",value:function(){var e=document.getElementsByClassName("sidebar"),t=document.getElementsByClassName("hamburger__bar");if(e[0].classList.contains("sidebar--show")){var r=!0,o=!1,n=void 0;try{for(var a,i=e[Symbol.iterator]();!(r=(a=i.next()).done);r=!0){var s=a.value;s.classList.add("sidebar--hide"),s.classList.remove("sidebar--show")}}catch(e){o=!0,n=e}finally{try{!r&&i.return&&i.return()}finally{if(o)throw n}}var l=!0,c=!1,d=void 0;try{for(var u,m=t[Symbol.iterator]();!(l=(u=m.next()).done);l=!0){u.value.classList.remove("hamburger__bar--active")}}catch(e){c=!0,d=e}finally{try{!l&&m.return&&m.return()}finally{if(c)throw d}}}else{var f=!0,y=!1,p=void 0;try{for(var v,h=e[Symbol.iterator]();!(f=(v=h.next()).done);f=!0){var g=v.value;g.classList.remove("sidebar--hide"),g.classList.add("sidebar--show")}}catch(e){y=!0,p=e}finally{try{!f&&h.return&&h.return()}finally{if(y)throw p}}var w=!0,k=!1,b=void 0;try{for(var L,M=t[Symbol.iterator]();!(w=(L=M.next()).done);w=!0){L.value.classList.add("hamburger__bar--active")}}catch(e){k=!0,b=e}finally{try{!w&&M.return&&M.return()}finally{if(k)throw b}}}}}],[{key:"closeFormLoadingMode",value:function(){l.closeFormLoadingMode()}},{key:"openErrorLoadingScreen",value:function(){l.closeFormLoadingMode(),l.openErrorLoadingScreen()}},{key:"openFormLoadingScreen",value:function(){l.openFormLoadingMode()}}]),e}();return s.corsServer="https://museum-guide-server.herokuapp.com",s.initialLoadPromise=new Promise(function(e,t){c.openFormLoadingScreen(),window.fetch(s.corsServer+"/model",{method:"GET"}).then(function(e){return e.json()}).then(function(t){s.defaultPosition=t.defaultArea.position,s.defaultType=t.defaultArea.type,window.ko&&(window.ko.options.deferUpdates=!0,c.instance=new c(t),window.ko.applyBindings(c.instance)),e()}).catch(function(e){s.errorLoadMap(),t(new Error(e.message))})}),s.returnModule()}();