/*! museum-guide | Patrick Dorosz | ISC */

var museumMapApp=function(){"use strict";var e=[{featureType:"all",elementType:"labels.text.fill",stylers:[{color:"#736c68"}]},{featureType:"landscape.man_made",elementType:"geometry.fill",stylers:[{color:"#e7e6e5"}]},{featureType:"landscape.natural",elementType:"all",stylers:[{visibility:"on"},{color:"#d4e4d3"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#f5f5f5"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#d4e4d3"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#f5f5f5"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#e7e6e5"},{gamma:"0.65"},{lightness:"0"}]},{featureType:"transit",elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#aad5df"}]}],t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),r=function(){function e(a,r){t(this,e),this.placesService=new window.google.maps.places.PlacesService(a),this.googleMapView=r}return a(e,[{key:"livePlacesSearch",value:function(e,t,a,r,n){function o(e,t){if(t===window.google.maps.places.PlacesServiceStatus.OK){var a=e.slice(0,10).map(function(e){return e.place_id});i.getDetailsFromPlaceIds(a,n)}else if(t===window.google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT)window.setTimeout(function(){i.placesService.nearbySearch(s,o)},200);else{var r=new Error(t);i.googleMapView.loadPlacesSearchResults(r)}}var i=this,s={keyword:e,location:t,name:r,radius:1e4,type:a};i.placesService.nearbySearch(s,o)}},{key:"getDetailsFromPlaceIds",value:function(e,t){var a=this,r=e.map(function(e){return new Promise(function(t,r){a.getDetailsFromSinglePlaceId(e,t,r)})});Promise.all(r).then(a.formatResults).then(function(e){a.googleMapView.loadPlacesSearchResults(e,t)}).catch(function(e){a.googleMapView.loadPlacesSearchResults(e,t)})}},{key:"getDetailsFromSinglePlaceId",value:function(e,t,a){var r=this;r.placesService.getDetails({placeId:e},function(n,o){if(o===window.google.maps.places.PlacesServiceStatus.OK)t(n);else if(o===window.google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT)window.setTimeout(function(){r.getDetailsFromSinglePlaceId(e,t,a)},200);else{var i=new Error(o);a(i)}})}},{key:"formatResults",value:function(e){return e.map(function(e){return{title:e.name,position:{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},type:"general",place_id:e.place_id}})}}]),e}(),n=function(){return{getYelpInfoHtml:function(e,t){var a='<div class="yelp">';return a+='<img class="yelp__image" src='+e.image_url.replace(/o\.jpg$/,"l.jpg")+' alt="Museum">',a+='<div class="yelp__info">',a+='<a class="yelp__rating" href="'+e.url+'" target="_blank">',a+=function(e){var t=Math.floor(e),a=e-t==.5?"_half":"",r='<img src="img/yelp_stars_reg/regular_';return r+=""+t+a+'.png" srcset="img/yelp_stars_reg/',r+="regular_"+t+a+'@2x.png 2x">'}(e.rating)+"</a>",a+='<a target="_blank" href="'+e.url+'">',a+='<img class="yelp__logo" src="img/yelp_trademark_rgb_outline.png" ',a+='srcset="img/yelp_trademark_rgb_outline_2x.png 2x" alt="Yelp Logo">',a+="</a>",a+='<a class="yelp__reviews" href="'+e.url+'" target="_blank">Based ',a+="on <strong>"+e.review_count+"</strong> review",a+=(e.review_count>1?"s":"")+"</a>",a+='<address class="yelp__address">'+function(e,t){return e[e.length-1].toLowerCase()===t.toLowerCase()&&(e=e.slice(0,e.length-1)),e.join("<br>")}(e.location.display_address,t),a+="</address>",e.hasOwnProperty("is_open_now")?(a+='<p class="yelp__open-now-phone">Currently <strong>',a+=(e.is_open_now?"OPEN":"CLOSED")+"</strong><br>"):a+='<p class="yelp__open-now-phone">',a+="Phone: "+e.display_phone+"</p>",a+="</div>",a+="</div>"},fetchYelpInfo:function(e,t){var a=t+"/yelp-search?term="+e.title.replace(/\s+/g,"+")+"&";return a+="lat="+e.position.lat()+"&",a+="lng="+e.position.lng(),window.fetch(a,{method:"GET"}).catch(function(e){return Promise.reject(e)}).then(function(e){return e.ok?e:Promise.reject(new Error("api.yelp.com connection error"))}).then(function(e){return e.json()})}}}(),o=function(){var e='<div class="sk-circle">';return Array(12).fill().map(function(e,t){return t+1}).forEach(function(t){e+='<div class="sk-circle'+t+' sk-child"></div>'}),e+="</div>"}(),i=function(e){var t="abcdefghijklmnopqrstuvwxyz0123456789",a="";e=e||6;for(var r=0;r<e;r++)a+=t.charAt(Math.floor(Math.random()*t.length));return a},s=function(){function s(){t(this,s)}return a(s,null,[{key:"closeInfoWindow",value:function(){s.mainInfoWindow.close(),s.mainInfoWindow.marker=void 0,c.instance.setSelectedMarker(void 0)}},{key:"deleteMarkers",value:function(){s.markers.forEach(function(e){e.setMap(void 0)}),s.markers=[],c.instance.clearMarkersObservable(),s.currentBounds=new window.google.maps.LatLngBounds}},{key:"errorLoadMap",value:function(){console.log("inside errorLoadMap"),c.instance&&(console.log("inside errorLoadMap & DisplayViewModel.instance exists"),c.instance.notifyMapLoadFail(!0))}},{key:"hideListView",value:function(){var e=document.getElementsByClassName("sidebar");if(e[0].classList.contains("sidebar--show")){var t=!0,a=!1,r=void 0;try{for(var n,o=e[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var i=n.value;i.classList.add("sidebar--hide"),i.classList.remove("sidebar--show")}}catch(e){a=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(a)throw r}}}}},{key:"initMap",value:function(){s.initialLoadPromise.then(function(){var t=document.getElementsByClassName("map")[0];s.map=new window.google.maps.Map(t,{center:{lat:s.defaultPosition.lat,lng:s.defaultPosition.lng},zoom:12,styles:e}),s.placesSearch=new r(s.map,s);document.getElementsByClassName("sidebar-list__live-search-loading")[0].insertAdjacentHTML("afterbegin",o),window.onresize=s.onWindowResize,t.addEventListener("click",s.hideListView),s.markers=[],(s.mainInfoWindow=new window.google.maps.InfoWindow({maxWidth:250})).addListener("closeclick",function(){s.mainInfoWindow.marker=void 0,c.instance.setSelectedMarker(void 0)})}).catch(console.log)}},{key:"livePlacesSearch",value:function(e,t,a){var r=i(5);s.currentSearchSessionHash=r,s.deleteMarkers(),s.placesSearch.livePlacesSearch(e,t,s.defaultType,a,r)}},{key:"loadMode",value:function(e,t){void 0!==s.mode&&s.modelCityObj===e&&"curated"===t&&"curated"===s.mode||(s.deleteMarkers(),s.modelCityObj=e,s.mode=t,"curated"===t&&s.loadMarkers(e.locations)),s.resetMap()}},{key:"loadMarkers",value:function(e){e.forEach(function(e){var t=new window.google.maps.Marker({position:e.position,title:e.title,animation:window.google.maps.Animation.DROP,icon:"img/icons/"+e.type+".png",map:s.map});t.addListener("click",function(){s.hideListView(),s.popInfoWindow(this)}),s.markers.push(t),s.currentBounds.extend(t.position)}),c.instance.markersReady(""),c.instance.markersReady(s.modelCityObj.cityName)}},{key:"loadPlacesSearchResults",value:function(e,t){t===s.currentSearchSessionHash&&(e instanceof Error?c.instance.searchPlacesCompleted("error"):0===e.length?c.instance.searchPlacesCompleted("noresults"):(s.deleteMarkers(),s.loadMarkers(e),s.map.fitBounds(s.currentBounds),c.instance.searchPlacesCompleted("success")))}},{key:"onWindowResize",value:function(){if(c.instance){var e=c.instance.getVisibleMarkers();e.length>1?s.mainInfoWindow.marker?(s.map.panTo(s.mainInfoWindow.marker.position),s.map.panBy(0,-340)):(s.resizeBounds=new window.google.maps.LatLngBounds,e.forEach(function(e){s.resizeBounds.extend(e.position)}),s.map.fitBounds(s.resizeBounds),s.resizeBounds=void 0,s.map.getZoom()>18&&s.map.setZoom(18)):1===e.length&&(s.map.panTo(e[0].position),s.map.panBy(0,-340))}if(window.matchMedia("(min-width: 768px)").matches){var t=document.getElementsByClassName("sidebar"),a=!0,r=!1,n=void 0;try{for(var o,i=t[Symbol.iterator]();!(a=(o=i.next()).done);a=!0){o.value.classList.remove("sidebar--show")}}catch(e){r=!0,n=e}finally{try{!a&&i.return&&i.return()}finally{if(r)throw n}}}}},{key:"popInfoWindow",value:function(e){function t(){var e=document.getElementsByClassName("info-window__arrows")[0],t="css: { 'btn--disabled': markersObservable().length < 2 }";e&&(e.children[0].setAttribute("data-bind","click: clickPrevArrow, "+t),e.children[1].setAttribute("data-bind","click: clickNextArrow, "+t),window.ko.applyBindings(c.instance,e))}function a(e,t){var a='<div class="info-window">';return a+='<div class="info-window__title"><strong>'+t+"</strong></div>",a+=e,a+=function(){var e='<div class="info-window__arrows">';return e+='<a href="#" role="button" class="btn info-window__arrows-prev"',e+=">&lt;</a>",e+='<a href="#" class="btn info-window__arrows-next" role="button"',e+=">&gt;</a>",e+="</div>"}(),a+="</div>"}if(s.toggleBounceMarker(e),s.mainInfoWindow.marker!==e){s.mainInfoWindow.marker=e,c.instance.setSelectedMarker(e),s.map.panTo(e.position),s.map.panBy(0,-340);var r=a(o,e.title);s.mainInfoWindow.setContent(r),s.mainInfoWindow.open(s.map,e),t(),n.fetchYelpInfo(e,s.corsServer).then(function(o){if(s.mainInfoWindow.marker===e){if(0===Object.keys(o).length){var i="<p>This location's information is not found in Yelp's business ";r=a(i+="directory. Try a different location.</p>",e.title),s.mainInfoWindow.setContent(r),t()}else{var l=n.getYelpInfoHtml(o,s.modelCityObj.country);r=a(l,e.title),s.mainInfoWindow.setContent(r),t()}}}).catch(function(n){if(s.mainInfoWindow.marker===e){var o="<p>Unable to retrieve this location's Yelp data due to a ";return o+="connection error. Please try again later.</p>",r=a(o,"Loading Error"),s.mainInfoWindow.setContent(r),t(),n}})}}},{key:"queryBoundsExtend",value:function(e){s.queryBounds||(s.queryBounds=new window.google.maps.LatLngBounds),s.queryBounds.extend(e)}},{key:"queryBoundsFit",value:function(e){e&&s.map.fitBounds(s.queryBounds),s.queryBounds=void 0,s.map.getZoom()>18&&s.map.setZoom(18)}},{key:"resetMap",value:function(){"curated"===s.mode?s.map.fitBounds(s.currentBounds):"liveSearch"===s.mode&&(s.currentSearchSessionHash=void 0,s.deleteMarkers(),s.map.panTo(s.modelCityObj.position)),s.mainInfoWindow.marker=void 0,s.mainInfoWindow.close(),c.instance.setSelectedMarker(void 0)}},{key:"returnModule",value:function(){return{errorLoadMap:s.errorLoadMap,initMap:s.initMap}}},{key:"setMarkerOnMap",value:function(e,t){t?e.setMap(s.map):e.setMap(void 0)}},{key:"toggleBounceMarker",value:function(e){e.getAnimation()?e.setAnimation(void 0):(s.markers.forEach(function(e){e.setAnimation(void 0)}),e.setAnimation(window.google.maps.Animation.BOUNCE),setTimeout(function(){return e.setAnimation(void 0)},1500))}}]),s}(),l=new(function(){function e(){t(this,e),this.modalElement=document.getElementsByClassName("modal")[0],this.modalElementContent=document.getElementsByClassName("modal__content")[0],this.modalElementCloseBtn=document.getElementsByClassName("modal__close-btn")[0],this.loadingFormElement=document.getElementsByClassName("form__load-screen")[0],this.isInitialModal=!0,this.loadingFormElement.insertAdjacentHTML("beforeend",o),setTimeout(this.launchFirstModal.bind(this),350),this.events()}return a(e,[{key:"events",value:function(){document.addEventListener("keyup",this.keyPressHandler.bind(this))}},{key:"launchFirstModal",value:function(){this.modalElementContent.classList.remove("modal__content--hidden")}},{key:"openModal",value:function(){!0===this.isInitialModal&&(this.isInitialModal=!1,this.modalElementCloseBtn.classList.remove("modal__close-btn--hidden")),this.modalElement.classList.remove("modal--hidden")}},{key:"closeModal",value:function(e){e.modalElement.classList.add("modal--hidden"),e.loadingFormElement.classList.remove("form__load-screen--visible")}},{key:"keyPressHandler",value:function(e){27===e.keyCode&&!1===this.isInitialModal&&this.closeModal(this)}},{key:"openFormLoadScreen",value:function(){this.loadingFormElement.classList.add("form__load-screen--visible")}}]),e}()),c=function(){function e(a){t(this,e);var r=this;r.mapLoadFail=window.ko.observable(!1),r.markersReady=window.ko.observable("").extend({notify:"always"}),r.markersObservable=window.ko.observableArray([]),r.selectedMarker=window.ko.observable(void 0),r.createMarkersObservable=window.ko.computed(function(){if(r.markersReady())return r.markersObservable(s.markers),r.markersSort(r.markersObservable),!0},r),r.query=window.ko.observable(""),r.queryOld=window.ko.observable(""),r.queryPlaceholder=window.ko.observable(""),r.query.subscribe(r.queryProcessInput,r),r.queryLiveSearch=window.ko.observable(r.query()),r.queryLiveSearchDelayed=window.ko.pureComputed(r.queryLiveSearch).extend({rateLimit:{method:"notifyWhenChangesStop",timeout:750}}),r.queryLiveSearchDelayed.subscribe(r.searchPlaces,r),r.queryLiveSearchLoading=window.ko.observable(!1),r.queryLiveSearchResultText=window.ko.observable(""),r.computedCityString=window.ko.observable(),r.displayedCityString=window.ko.observable(),r.form={},r.form.selectedCityValue=window.ko.observable("Tokyo"),r.form.selectedListMode=window.ko.observable("curated"),r.form.optionsCities=a.cities.map(function(e){return{cityString:e.cityName+(e.localLang?" - "+e.localLang:""),cityValue:e.cityName}}),r.form.selectedCityObj=window.ko.computed(function(){var e=a.cities.find(function(e){return e.cityName.toLowerCase()===r.form.selectedCityValue().toLowerCase()});return e&&(e.localLang?r.computedCityString(e.cityName+" - "+e.localLang):r.computedCityString(e.cityName)),e}),r.form.curatedDisabled=window.ko.computed(function(){return 0===r.form.selectedCityObj().locations.length?(r.form.selectedListMode("liveSearch"),!0):(r.form.selectedListMode("curated"),!1)})}return a(e,[{key:"clickArrow",value:function(e){if(this.markersObservable().length>1){var t=(this.markersObservable.indexOf(s.mainInfoWindow.marker)+e)%this.markersObservable().length;-1===t&&(t=this.markersObservable().length-1);var a=this.markersObservable()[t];s.popInfoWindow(a)}}},{key:"clickLocationList",value:function(t){window.matchMedia("(max-width: 767px)").matches&&e.instance.toggleSidebar(),s.popInfoWindow(t)}},{key:"changeCity",value:function(){l.openModal()}},{key:"clickNextArrow",value:function(){this.clickArrow(1)}},{key:"clickPrevArrow",value:function(){this.clickArrow(-1)}},{key:"closeModal",value:function(){l.closeModal(l)}},{key:"clearMarkersObservable",value:function(){this.markersObservable([])}},{key:"filterMarkerList",value:function(e){if(""!==e){this.markersObservable([]),s.markers.forEach(function(t){t.title.toUpperCase().indexOf(e.toUpperCase())>=0?(this.markersObservable.push(t),t.getMap()||s.setMarkerOnMap(t,!0),s.queryBoundsExtend(t.position)):s.setMarkerOnMap(t,!1)},this);var t=this.markersObservable().length;1===t?(s.mainInfoWindow.marker||s.popInfoWindow(this.markersObservable()[0]),s.queryBoundsFit(!1)):t>1&&(s.closeInfoWindow(),this.markersSort(this.markersObservable),s.queryBoundsFit(!0))}else s.markers.forEach(function(e){e.getMap()||s.setMarkerOnMap(e,!0)}),this.markersObservable(s.markers),this.markersSort(this.markersObservable),this.resetMap()}},{key:"getVisibleMarkers",value:function(){return this.markersObservable()}},{key:"listElementInfoWindowOpen",value:function(e){return this.selectedMarker()===e}},{key:"loadFormData",value:function(){"curated"===this.form.selectedListMode()?(this.queryPlaceholder("Filter..."),s.loadMode(this.form.selectedCityObj(),"curated")):"liveSearch"===this.form.selectedListMode()&&(this.queryPlaceholder("Search..."),s.loadMode(this.form.selectedCityObj(),"liveSearch")),this.query(""),this.queryLiveSearchResultText(""),this.displayedCityString(this.computedCityString()),l.closeModal(l)}},{key:"notifyMapLoadFail",value:function(e){this.mapLoadFail(e)}},{key:"markersSort",value:function(e){e.sort(function(e,t){return e.title===t.title?0:e.title>t.title?1:-1})}},{key:"queryProcessInput",value:function(e){(e=e.trim())!==this.queryOld()&&(this.queryOld(e),"curated"===this.form.selectedListMode()?this.filterMarkerList(e):"liveSearch"===this.form.selectedListMode()&&this.queryLiveSearch(this.query()))}},{key:"resetMap",value:function(){this.query(""),this.queryLiveSearchResultText(""),this.queryLiveSearchLoading(!1),s.resetMap()}},{key:"searchPlaces",value:function(e){if(e.length>2){this.queryLiveSearchLoading(!0);var t=this.form.selectedCityObj().cityName,a=this.form.selectedCityObj().position;s.livePlacesSearch(t,a,e)}}},{key:"searchPlacesCompleted",value:function(e){this.queryLiveSearchLoading(!1),"success"===e?this.queryLiveSearchResultText(""):"noresults"===e?this.queryLiveSearchResultText("No Results"):"error"===e&&this.queryLiveSearchResultText("Search Error")}},{key:"setSelectedMarker",value:function(e){this.selectedMarker(e)}},{key:"submitModal",value:function(){l.openFormLoadScreen(),this.loadFormData()}},{key:"toggleSidebar",value:function(){var e=document.getElementsByClassName("sidebar"),t=document.getElementsByClassName("hamburger__bar");if(e[0].classList.contains("sidebar--show")){var a=!0,r=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(a=(o=i.next()).done);a=!0){var s=o.value;s.classList.add("sidebar--hide"),s.classList.remove("sidebar--show")}}catch(e){r=!0,n=e}finally{try{!a&&i.return&&i.return()}finally{if(r)throw n}}var l=!0,c=!1,d=void 0;try{for(var u,m=t[Symbol.iterator]();!(l=(u=m.next()).done);l=!0){u.value.classList.remove("hamburger__bar--active")}}catch(e){c=!0,d=e}finally{try{!l&&m.return&&m.return()}finally{if(c)throw d}}}else{var f=!0,y=!1,p=void 0;try{for(var h,v=e[Symbol.iterator]();!(f=(h=v.next()).done);f=!0){var w=h.value;w.classList.remove("sidebar--hide"),w.classList.add("sidebar--show")}}catch(e){y=!0,p=e}finally{try{!f&&v.return&&v.return()}finally{if(y)throw p}}var g=!0,k=!1,b=void 0;try{for(var M,L=t[Symbol.iterator]();!(g=(M=L.next()).done);g=!0){M.value.classList.add("hamburger__bar--active")}}catch(e){k=!0,b=e}finally{try{!g&&L.return&&L.return()}finally{if(k)throw b}}}}}]),e}();return s.corsServer="https://museum-guide-server.herokuapp.com",s.initialLoadPromise=new Promise(function(e,t){window.fetch(s.corsServer+"/model",{method:"GET"}).then(function(e){return e.json()}).then(function(t){var a=t;s.defaultPosition=a.defaultArea.position,s.defaultType=a.defaultArea.type,window.ko&&(window.ko.options.deferUpdates=!0,c.instance=new c(a),window.ko.applyBindings(c.instance)),e()}).catch(function(e){console.log("inside app.js catch"),s.errorLoadMap(),t(e)})}),s.returnModule()}();