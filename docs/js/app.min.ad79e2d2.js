/*! museum-guide | Patrick Dorosz | ISC */

var museumMapApp=function(){"use strict";var e=[{featureType:"all",elementType:"labels.text.fill",stylers:[{color:"#736c68"}]},{featureType:"landscape.man_made",elementType:"geometry.fill",stylers:[{color:"#e7e6e5"}]},{featureType:"landscape.natural",elementType:"all",stylers:[{visibility:"on"},{color:"#d4e4d3"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#f5f5f5"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#d4e4d3"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#f5f5f5"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#e7e6e5"},{gamma:"0.65"},{lightness:"0"}]},{featureType:"transit",elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#aad5df"}]}],t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),a=function(){function e(r,a){t(this,e),this.placesService=new window.google.maps.places.PlacesService(r),this.googleMapView=a}return r(e,[{key:"livePlacesSearch",value:function(e,t,r,a,n){function o(e,t){if(t===window.google.maps.places.PlacesServiceStatus.OK){var r=e.slice(0,10).map(function(e){return e.place_id});i.getDetailsFromPlaceIds(r,n)}else if(t===window.google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT)window.setTimeout(function(){i.placesService.nearbySearch(s,o)},200);else{var a=new Error(t);i.googleMapView.loadPlacesSearchResults(a)}}var i=this,s={keyword:e,location:t,name:a,radius:1e4,type:r};i.placesService.nearbySearch(s,o)}},{key:"getDetailsFromPlaceIds",value:function(e,t){var r=this,a=e.map(function(e){return new Promise(function(t,a){r.getDetailsFromSinglePlaceId(e,t,a)})});Promise.all(a).then(r.formatResults).then(function(e){r.googleMapView.loadPlacesSearchResults(e,t)}).catch(function(e){r.googleMapView.loadPlacesSearchResults(e,t)})}},{key:"getDetailsFromSinglePlaceId",value:function(e,t,r){var a=this;a.placesService.getDetails({placeId:e},function(n,o){if(o===window.google.maps.places.PlacesServiceStatus.OK)t(n);else if(o===window.google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT)window.setTimeout(function(){a.getDetailsFromSinglePlaceId(e,t,r)},200);else{var i=new Error(o);r(i)}})}},{key:"formatResults",value:function(e){return e.map(function(e){return{title:e.name,position:{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},type:"general",place_id:e.place_id}})}}]),e}(),n=function(){return{getYelpInfoHtml:function(e,t){var r='<div class="yelp">';return r+='<img class="yelp__image" src='+e.image_url.replace(/o\.jpg$/,"l.jpg")+' alt="Museum">',r+='<div class="yelp__info">',r+='<a class="yelp__rating" href="'+e.url+'" target="_blank">',r+=function(e){var t=Math.floor(e),r=e-t==.5?"_half":"",a='<img src="img/yelp_stars_reg/regular_';return a+=""+t+r+'.png" srcset="img/yelp_stars_reg/',a+="regular_"+t+r+'@2x.png 2x">'}(e.rating)+"</a>",r+='<a target="_blank" href="'+e.url+'">',r+='<img class="yelp__logo" src="img/yelp_trademark_rgb_outline.png" ',r+='srcset="img/yelp_trademark_rgb_outline_2x.png 2x" alt="Yelp Logo">',r+="</a>",r+='<a class="yelp__reviews" href="'+e.url+'" target="_blank">Based ',r+="on <strong>"+e.review_count+"</strong> review",r+=(e.review_count>1?"s":"")+"</a>",r+='<address class="yelp__address">'+function(e,t){return e[e.length-1].toLowerCase()===t.toLowerCase()&&(e=e.slice(0,e.length-1)),e.join("<br>")}(e.location.display_address,t),r+="</address>",e.hasOwnProperty("is_open_now")?(r+='<p class="yelp__open-now-phone">Currently <strong>',r+=(e.is_open_now?"OPEN":"CLOSED")+"</strong><br>"):r+='<p class="yelp__open-now-phone">',r+="Phone: "+e.display_phone+"</p>",r+="</div>",r+="</div>"},fetchYelpInfo:function(e,t){var r=t+"/yelp-search?term="+e.title.replace(/\s+/g,"+")+"&";return r+="lat="+e.position.lat()+"&",r+="lng="+e.position.lng(),window.fetch(r,{method:"GET"}).catch(function(e){return Promise.reject(e)}).then(function(e){return e.ok?e:Promise.reject(new Error("api.yelp.com connection error"))}).then(function(e){return e.json()})}}}(),o=function(){var e='<div class="sk-circle">';return Array(12).fill().map(function(e,t){return t+1}).forEach(function(t){e+='<div class="sk-circle'+t+' sk-child"></div>'}),e+="</div>"}(),i=function(e){var t="abcdefghijklmnopqrstuvwxyz0123456789",r="";e=e||6;for(var a=0;a<e;a++)r+=t.charAt(Math.floor(Math.random()*t.length));return r},s=function(){function s(){t(this,s)}return r(s,null,[{key:"closeInfoWindow",value:function(){s.mainInfoWindow.close(),s.mainInfoWindow.marker=void 0,c.instance.setSelectedMarker(void 0)}},{key:"deleteMarkers",value:function(){s.markers.forEach(function(e){e.setMap(void 0)}),s.markers=[],c.instance.clearMarkersObservable(),s.currentBounds=new window.google.maps.LatLngBounds}},{key:"errorLoadMap",value:function(){c.instance&&c.instance.notifyMapLoadFail(!0)}},{key:"hideListView",value:function(){var e=document.getElementsByClassName("sidebar");if(e[0].classList.contains("sidebar--show")){var t=!0,r=!1,a=void 0;try{for(var n,o=e[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var i=n.value;i.classList.add("sidebar--hide"),i.classList.remove("sidebar--show")}}catch(e){r=!0,a=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw a}}}}},{key:"initMap",value:function(){s.initialLoadPromise.then(function(){var t=document.getElementsByClassName("map")[0];s.map=new window.google.maps.Map(t,{center:{lat:s.defaultPosition.lat,lng:s.defaultPosition.lng},zoom:12,styles:e}),s.placesSearch=new a(s.map,s);document.getElementsByClassName("sidebar-list__live-search-loading")[0].insertAdjacentHTML("afterbegin",o),window.onresize=s.onWindowResize,t.addEventListener("click",s.hideListView),s.markers=[],(s.mainInfoWindow=new window.google.maps.InfoWindow({maxWidth:250})).addListener("closeclick",function(){s.mainInfoWindow.marker=void 0,c.instance.setSelectedMarker(void 0)})})}},{key:"livePlacesSearch",value:function(e,t,r){var a=i(5);s.currentSearchSessionHash=a,s.deleteMarkers(),s.placesSearch.livePlacesSearch(e,t,s.defaultType,r,a)}},{key:"loadMode",value:function(e,t){void 0!==s.mode&&s.modelCityObj===e&&"curated"===t&&"curated"===s.mode||(s.deleteMarkers(),s.modelCityObj=e,s.mode=t,"curated"===t&&s.loadMarkers(e.locations)),s.resetMap()}},{key:"loadMarkers",value:function(e){e.forEach(function(e){var t=new window.google.maps.Marker({position:e.position,title:e.title,animation:window.google.maps.Animation.DROP,icon:"img/icons/"+e.type+".png",map:s.map});t.addListener("click",function(){s.hideListView(),s.popInfoWindow(this)}),s.markers.push(t),s.currentBounds.extend(t.position)}),c.instance.markersReady(""),c.instance.markersReady(s.modelCityObj.cityName)}},{key:"loadPlacesSearchResults",value:function(e,t){t===s.currentSearchSessionHash&&(e instanceof Error?c.instance.searchPlacesCompleted("error"):0===e.length?c.instance.searchPlacesCompleted("noresults"):(s.deleteMarkers(),s.loadMarkers(e),s.map.fitBounds(s.currentBounds),c.instance.searchPlacesCompleted("success")))}},{key:"onWindowResize",value:function(){if(c.instance){var e=c.instance.getVisibleMarkers();e.length>1?s.mainInfoWindow.marker?(s.map.panTo(s.mainInfoWindow.marker.position),s.map.panBy(0,-340)):(s.resizeBounds=new window.google.maps.LatLngBounds,e.forEach(function(e){s.resizeBounds.extend(e.position)}),s.map.fitBounds(s.resizeBounds),s.resizeBounds=void 0,s.map.getZoom()>18&&s.map.setZoom(18)):1===e.length&&(s.map.panTo(e[0].position),s.map.panBy(0,-340))}if(window.matchMedia("(min-width: 768px)").matches){var t=document.getElementsByClassName("sidebar"),r=!0,a=!1,n=void 0;try{for(var o,i=t[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){o.value.classList.remove("sidebar--show")}}catch(e){a=!0,n=e}finally{try{!r&&i.return&&i.return()}finally{if(a)throw n}}}}},{key:"popInfoWindow",value:function(e){function t(){var e=document.getElementsByClassName("info-window__arrows")[0],t="css: { 'btn--disabled': markersObservable().length < 2 }";e&&(e.children[0].setAttribute("data-bind","click: clickPrevArrow, "+t),e.children[1].setAttribute("data-bind","click: clickNextArrow, "+t),window.ko.applyBindings(c.instance,e))}function r(e,t){var r='<div class="info-window">';return r+='<div class="info-window__title"><strong>'+t+"</strong></div>",r+=e,r+=function(){var e='<div class="info-window__arrows">';return e+='<a href="#" role="button" class="btn info-window__arrows-prev"',e+=">&lt;</a>",e+='<a href="#" class="btn info-window__arrows-next" role="button"',e+=">&gt;</a>",e+="</div>"}(),r+="</div>"}if(s.toggleBounceMarker(e),s.mainInfoWindow.marker!==e){s.mainInfoWindow.marker=e,c.instance.setSelectedMarker(e),s.map.panTo(e.position),s.map.panBy(0,-340);var a=r(o,e.title);s.mainInfoWindow.setContent(a),s.mainInfoWindow.open(s.map,e),t(),n.fetchYelpInfo(e,s.corsServer).then(function(o){if(s.mainInfoWindow.marker===e){if(0===Object.keys(o).length){var i="<p>This location's information is not found in Yelp's business ";a=r(i+="directory. Try a different location.</p>",e.title),s.mainInfoWindow.setContent(a),t()}else{var l=n.getYelpInfoHtml(o,s.modelCityObj.country);a=r(l,e.title),s.mainInfoWindow.setContent(a),t()}}}).catch(function(n){if(s.mainInfoWindow.marker===e){var o="<p>Unable to retrieve this location's Yelp data due to a ";return o+="connection error. Please try again later.</p>",a=r(o,"Loading Error"),s.mainInfoWindow.setContent(a),t(),n}})}}},{key:"queryBoundsExtend",value:function(e){s.queryBounds||(s.queryBounds=new window.google.maps.LatLngBounds),s.queryBounds.extend(e)}},{key:"queryBoundsFit",value:function(e){e&&s.map.fitBounds(s.queryBounds),s.queryBounds=void 0,s.map.getZoom()>18&&s.map.setZoom(18)}},{key:"resetMap",value:function(){"curated"===s.mode?s.map.fitBounds(s.currentBounds):"liveSearch"===s.mode&&(s.currentSearchSessionHash=void 0,s.deleteMarkers(),s.map.panTo(s.modelCityObj.position)),s.mainInfoWindow.marker=void 0,s.mainInfoWindow.close(),c.instance.setSelectedMarker(void 0)}},{key:"returnModule",value:function(){return{errorLoadMap:s.errorLoadMap,initMap:s.initMap}}},{key:"setMarkerOnMap",value:function(e,t){t?e.setMap(s.map):e.setMap(void 0)}},{key:"toggleBounceMarker",value:function(e){e.getAnimation()?e.setAnimation(void 0):(s.markers.forEach(function(e){e.setAnimation(void 0)}),e.setAnimation(window.google.maps.Animation.BOUNCE),setTimeout(function(){return e.setAnimation(void 0)},1500))}}]),s}(),l=new(function(){function e(){t(this,e),this.modalElement=document.getElementsByClassName("modal")[0],this.modalElementContent=document.getElementsByClassName("modal__content")[0],this.modalElementCloseBtn=document.getElementsByClassName("modal__close-btn")[0],this.loadingFormElement=document.getElementsByClassName("form__load-screen")[0],this.isInitialModal=!0,this.loadingFormElement.insertAdjacentHTML("beforeend",o),setTimeout(this.launchFirstModal.bind(this),350),this.events()}return r(e,[{key:"events",value:function(){document.addEventListener("keyup",this.keyPressHandler.bind(this))}},{key:"launchFirstModal",value:function(){this.modalElementContent.classList.remove("modal__content--hidden")}},{key:"openModal",value:function(){!0===this.isInitialModal&&(this.isInitialModal=!1,this.modalElementCloseBtn.classList.remove("modal__close-btn--hidden")),this.modalElement.classList.remove("modal--hidden")}},{key:"closeModal",value:function(e){e.modalElement.classList.add("modal--hidden"),e.loadingFormElement.classList.remove("form__load-screen--visible")}},{key:"keyPressHandler",value:function(e){27===e.keyCode&&!1===this.isInitialModal&&this.closeModal(this)}},{key:"openFormLoadScreen",value:function(){this.loadingFormElement.classList.add("form__load-screen--visible")}}]),e}()),c=function(){function e(r){t(this,e);var a=this;a.mapLoadFail=window.ko.observable(!1),a.markersReady=window.ko.observable("").extend({notify:"always"}),a.markersObservable=window.ko.observableArray([]),a.selectedMarker=window.ko.observable(void 0),a.createMarkersObservable=window.ko.computed(function(){if(a.markersReady())return a.markersObservable(s.markers),a.markersSort(a.markersObservable),!0},a),a.query=window.ko.observable(""),a.queryOld=window.ko.observable(""),a.queryPlaceholder=window.ko.observable(""),a.query.subscribe(a.queryProcessInput,a),a.queryLiveSearch=window.ko.observable(a.query()),a.queryLiveSearchDelayed=window.ko.pureComputed(a.queryLiveSearch).extend({rateLimit:{method:"notifyWhenChangesStop",timeout:750}}),a.queryLiveSearchDelayed.subscribe(a.searchPlaces,a),a.queryLiveSearchLoading=window.ko.observable(!1),a.queryLiveSearchResultText=window.ko.observable(""),a.computedCityString=window.ko.observable(),a.displayedCityString=window.ko.observable(),a.form={},a.form.selectedCityValue=window.ko.observable("Tokyo"),a.form.selectedListMode=window.ko.observable("curated"),a.form.optionsCities=r.cities.map(function(e){return{cityString:e.cityName+(e.localLang?" - "+e.localLang:""),cityValue:e.cityName}}),a.form.selectedCityObj=window.ko.computed(function(){var e=r.cities.find(function(e){return e.cityName.toLowerCase()===a.form.selectedCityValue().toLowerCase()});return e&&(e.localLang?a.computedCityString(e.cityName+" - "+e.localLang):a.computedCityString(e.cityName)),e}),a.form.curatedDisabled=window.ko.computed(function(){return 0===a.form.selectedCityObj().locations.length?(a.form.selectedListMode("liveSearch"),!0):(a.form.selectedListMode("curated"),!1)})}return r(e,[{key:"clickArrow",value:function(e){if(this.markersObservable().length>1){var t=(this.markersObservable.indexOf(s.mainInfoWindow.marker)+e)%this.markersObservable().length;-1===t&&(t=this.markersObservable().length-1);var r=this.markersObservable()[t];s.popInfoWindow(r)}}},{key:"clickLocationList",value:function(t){window.matchMedia("(max-width: 767px)").matches&&e.instance.toggleSidebar(),s.popInfoWindow(t)}},{key:"changeCity",value:function(){l.openModal()}},{key:"clickNextArrow",value:function(){this.clickArrow(1)}},{key:"clickPrevArrow",value:function(){this.clickArrow(-1)}},{key:"closeModal",value:function(){l.closeModal(l)}},{key:"clearMarkersObservable",value:function(){this.markersObservable([])}},{key:"filterMarkerList",value:function(e){if(""!==e){this.markersObservable([]),s.markers.forEach(function(t){t.title.toUpperCase().indexOf(e.toUpperCase())>=0?(this.markersObservable.push(t),t.getMap()||s.setMarkerOnMap(t,!0),s.queryBoundsExtend(t.position)):s.setMarkerOnMap(t,!1)},this);var t=this.markersObservable().length;1===t?(s.mainInfoWindow.marker||s.popInfoWindow(this.markersObservable()[0]),s.queryBoundsFit(!1)):t>1&&(s.closeInfoWindow(),this.markersSort(this.markersObservable),s.queryBoundsFit(!0))}else s.markers.forEach(function(e){e.getMap()||s.setMarkerOnMap(e,!0)}),this.markersObservable(s.markers),this.markersSort(this.markersObservable),this.resetMap()}},{key:"getVisibleMarkers",value:function(){return this.markersObservable()}},{key:"listElementInfoWindowOpen",value:function(e){return this.selectedMarker()===e}},{key:"loadFormData",value:function(){"curated"===this.form.selectedListMode()?(this.queryPlaceholder("Filter..."),s.loadMode(this.form.selectedCityObj(),"curated")):"liveSearch"===this.form.selectedListMode()&&(this.queryPlaceholder("Search..."),s.loadMode(this.form.selectedCityObj(),"liveSearch")),this.query(""),this.queryLiveSearchResultText(""),this.displayedCityString(this.computedCityString()),l.closeModal(l)}},{key:"notifyMapLoadFail",value:function(e){this.mapLoadFail(e)}},{key:"markersSort",value:function(e){e.sort(function(e,t){return e.title===t.title?0:e.title>t.title?1:-1})}},{key:"queryProcessInput",value:function(e){(e=e.trim())!==this.queryOld()&&(this.queryOld(e),"curated"===this.form.selectedListMode()?this.filterMarkerList(e):"liveSearch"===this.form.selectedListMode()&&this.queryLiveSearch(this.query()))}},{key:"resetMap",value:function(){this.query(""),this.queryLiveSearchResultText(""),this.queryLiveSearchLoading(!1),s.resetMap()}},{key:"searchPlaces",value:function(e){if(e.length>2){this.queryLiveSearchLoading(!0);var t=this.form.selectedCityObj().cityName,r=this.form.selectedCityObj().position;s.livePlacesSearch(t,r,e)}}},{key:"searchPlacesCompleted",value:function(e){this.queryLiveSearchLoading(!1),"success"===e?this.queryLiveSearchResultText(""):"noresults"===e?this.queryLiveSearchResultText("No Results"):"error"===e&&this.queryLiveSearchResultText("Search Error")}},{key:"setSelectedMarker",value:function(e){this.selectedMarker(e)}},{key:"submitModal",value:function(){l.openFormLoadScreen(),this.loadFormData()}},{key:"toggleSidebar",value:function(){var e=document.getElementsByClassName("sidebar"),t=document.getElementsByClassName("hamburger__bar");if(e[0].classList.contains("sidebar--show")){var r=!0,a=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var s=o.value;s.classList.add("sidebar--hide"),s.classList.remove("sidebar--show")}}catch(e){a=!0,n=e}finally{try{!r&&i.return&&i.return()}finally{if(a)throw n}}var l=!0,c=!1,d=void 0;try{for(var u,m=t[Symbol.iterator]();!(l=(u=m.next()).done);l=!0){u.value.classList.remove("hamburger__bar--active")}}catch(e){c=!0,d=e}finally{try{!l&&m.return&&m.return()}finally{if(c)throw d}}}else{var f=!0,y=!1,p=void 0;try{for(var h,v=e[Symbol.iterator]();!(f=(h=v.next()).done);f=!0){var w=h.value;w.classList.remove("sidebar--hide"),w.classList.add("sidebar--show")}}catch(e){y=!0,p=e}finally{try{!f&&v.return&&v.return()}finally{if(y)throw p}}var k=!0,g=!1,b=void 0;try{for(var M,L=t[Symbol.iterator]();!(k=(M=L.next()).done);k=!0){M.value.classList.add("hamburger__bar--active")}}catch(e){g=!0,b=e}finally{try{!k&&L.return&&L.return()}finally{if(g)throw b}}}}}]),e}();return s.corsServer="https://museum-guide-server.herokuapp.com",s.initialLoadPromise=new Promise(function(e,t){window.fetch(s.corsServer+"/model",{method:"GET"}).then(function(e){return e.json()}).then(function(t){var r=t;s.defaultPosition=r.defaultArea.position,s.defaultType=r.defaultArea.type,window.ko&&(window.ko.options.deferUpdates=!0,c.instance=new c(r),window.ko.applyBindings(c.instance)),e()}).catch(function(e){s.errorLoadMap(),t(e)})}),s.returnModule()}();